stages:
  - clean
  - compile
  - build
  - copy
  - verify

mvn-clean:
  stage: clean
  script:
    - sudo mvn clean

mvn-compile:
  stage: compile
  script:
    - sudo mvn compile -DskipTests=true

java-build:
  image: maven:3.8-openjdk-17
  stage: build
  cache:
    key: "maven-$CI_COMMIT_REF_SLUG"
    paths:
      - .m2/repository
  script:
    - sudo mvn package -DskipTests=true -Drevision=$CI_PIPELINE_IID
  artifacts:
    name: "Maven artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    paths:
      - "target/$CI_PROJECT_NAME*.jar"

move:
  stage: copy
  allow_failure: true
  script:
    - sudo cp $CI_PROJECT_DIR/target/$CI_PROJECT_NAME*.jar /opt/mc.indexoutofmj.net/plugins/plugins/$CI_PROJECT_NAME.jar

sonarqube-check:
  stage: verify
  image: maven:3.8-openjdk-17
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sudo mvn verify sonar:sonar -Dsonar.projectKey=gitlab-instance-171ddc14_neptunebot_AYLHoFzRioP8OUhoT-EE
  allow_failure: true
  only:
    - master # or the name of your main branch
